# Настройка системы (OS)

## 1. Настройка OOBE

- Windows Server может потребовать от вас ввести пароль, который можно будет удалить на более поздних этапах настройки.

- Если вы настраиваете Windows 11, нажмите ``Shift+F10``, чтобы открыть командную строку, и выполните команду ``oobe\BypassNRO.cmd``. Это позволит продолжить установку без подключения к интернету, разблокировав опцию ``продолжить с ограниченной настройкой``, как показано в видео ниже. Также это убирает необходимость входа с использованием учетной записи Microsoft, что я настоятельно не рекомендую по соображениям конфиденциальности.

- Посмотрите [oobe-windows7-example.mp4](https://github.com/couwthynokap/Setting-up-the-computer-and-Windows-10-11/blob/main/videos/oobe-windows7-example.mp4)
- Посмотрите [oobe-windows8-example.mp4](https://github.com/couwthynokap/Setting-up-the-computer-and-Windows-10-11/blob/main/videos/oobe-windows8-example.mp4)
- Посмотрите [oobe-windows10+-example.mp4](https://github.com/couwthynokap/Setting-up-the-computer-and-Windows-10-11/blob/main/videos/oobe-windows10%2B-example.mp4)

---

## 2. Настройка после установки

Настройте меню "Пуск", ярлыки и панель задач по своему усмотрению. Настройки персонализации можно будет изменить позже.

- При необходимости установите обновления через Центр обновлений.

Переместите папку ``files`` из репозитория в корневую директорию системного диска (в итоге должно получиться так: ``C:\files\``).

## 3. Импорт настроек в реестр

>**⚠**
>  Я не утверждаю, что это идеальная конфигурация реестра и что у неё нет недостатков. При желании вы можете самостоятельно внести изменения в файл конфигурации. **Скрипт не восстанавливает настройки при изменении значений с "true" на "false".**

Это необходимо для корректного выполнения скриптов из репозитория. Запустите PowerShell с правами администратора (не через Win+R, а через меню "Пуск") и введите следующую команду.

```powershell
Set-ExecutionPolicy Unrestricted
```

Затем откройте файл конфигурации:
```bat
C:\files\registry-options.json
```

Проверьте установленные параметры и при необходимости измените их на подходящие для вас.

### Таблица настроек реестра
|Опция|Причина|Описание|Значение по умолчанию|
|---|---|---|---|
|``disable windows update``|1. Уменьшение нагрузки на процессор<br><br>2. Более точный контроль над функцией|Отключение Windows Update рекомендуется Microsoft для настройки устройств с целью повышения производительности в реальном времени ([1](https://learn.microsoft.com/en-us/windows/iot/iot-enterprise/soft-real-time/soft-real-time-device)). Вместо полного отключения Windows Update можно просто отключить автоматические обновления, что также снижает нагрузку на процессор, но позволяет обновлять Windows, установив ``disable windows update`` в ``false`` и ``disable automatic windows updates`` в ``true``. Известно, что процессы обновления Windows требуют значительных ресурсов процессора и памяти. Отключение Windows Update может повлиять на работу Microsoft Store, однако вы можете загружать и устанавливать пакеты Appx напрямую ([инструкции](https://superuser.com/questions/1721755/is-there-a-way-to-install-microsoft-store-exclusive-apps-without-store))<br><br>Этот параметр не влияет на обновления, которые можно контролировать с помощью групповых политик ([инструкции](https://www.tenforums.com/tutorials/159624-how-specify-target-feature-update-version-windows-10-a.html)). Однако вы ограничены в предотвращении обновлений до тех пор, пока указанная версия не достигнет конца срока службы|``false``|
|``disable automatic windows updates``|1. Уменьшение нагрузки на процессор<br><br>2. Более точный контроль над функцией|Запрещает автоматическую загрузку и установку обновлений Windows, вместо полного отключения Windows Update и периодической проверки обновлений вручную. Обновления могут происходить в неподходящее время, что приводит к чрезмерному использованию процессора и памяти, а также может нарушить процесс выключения в некоторых случаях. Эта опция отменяется, если для параметра ``disable windows update`` установлено значение ``true``.<br><br>Этот параметр не влияет на обновления, которые можно контролировать с помощью групповых политик ([инструкции](https://www.tenforums.com/tutorials/159624-how-specify-target-feature-update-version-windows-10-a.html)). Однако вы можете предотвратить обновления только до тех пор, пока указанная версия не достигнет конца срока службы|``true``|
|``disable driver installation via windows update``|1. Уменьшение нагрузки на процессор<br><br>2. Более точный контроль над функцией|Запрещает установку устаревших, уязвимых и потенциально проблемных драйверов через Windows Update. Рекомендуется вручную устанавливать только необходимые версии драйверов для вашей системы (так как полные установки часто включают дополнительные программы, работающие в фоновом режиме), а также последние версии непосредственно с сайта производителя, как описано в разделе [Установка драйверов](#установка-драйверов). Эта опция отменяется, если для параметра ``disable windows update`` установлено значение ``true``.|``true``|
|``disable automatic store app updates``|1. Уменьшение нагрузки на процессор<br><br>2. Более точный контроль над функцией|Запрещает автоматическую загрузку и установку обновлений приложений из магазина, что предпочтительнее полного отключения обновлений приложений с точки зрения снижения нагрузки на процессор. Вместо этого проверяйте наличие обновлений приложений вручную время от времени.|``true``|
|``disable windows defender``|1. Уменьшение нагрузки на процессор<br><br>2. Предотвращает проблемы с переходом процессора в состояние C-State 0 ([1](https://www.techpowerup.com/295877/windows-defender-can-significantly-impact-intel-cpu-performance-we-have-the-fix))|Эта опция полностью отключает Защитник Windows. Вместо этого рекомендуется регулярно проводить сканирование системы, использовать защищенный браузер с [uBlock Origin](https://ublockorigin.com), держать UAC включенным и отдавать предпочтение бесплатному, открытому исходному коду и надежному программному обеспечению. Избегайте проприетарного ПО, где это возможно, и проверяйте файлы и исполняемые файлы с помощью [VirusTotal](https://www.virustotal.com/gui/home/upload) перед их открытием.|``true``|
|``disable gamebarpresencewriter``|1. Уменьшение нагрузки на процессор|Процесс постоянно работает в фоновом режиме и, по имеющимся данным, не требуется для функционирования игрового режима или игровой панели.|``true``|
|``disable background apps``|1. Уменьшение нагрузки на процессор|Запрещает приложениям работать в фоновом режиме. Фоновые приложения отключаются с помощью политик, так как в интерфейсе Windows 11 эта опция недоступна.|``true``|
|``disable transparency effects``|1. Уменьшение нагрузки на процессор ([1](/assets/images/transparency-effects-benchmark.png))|Отключает эффекты прозрачности.|``true``|
|``disable notifications network usage``|1. Снижение телеметрии ([1](https://learn.microsoft.com/en-gb/windows/privacy/manage-connections-from-windows-operating-system-components-to-microsoft-services#10-live-tiles))|N/A|``true``|
|``disable windows marking file attachments with information about their zone of origin``|1. Уменьшение или отключение навязчивых элементов|Предотвращает [это](https://www.tenforums.com/tutorials/85418-how-disable-downloaded-files-being-blocked-windows.html) навязчивые предупреждения безопасности, так как загруженные файлы требуют разблокировки, однако это может негативно сказаться на безопасности, поскольку пользователь не будет уведомлен о заблокированных файлах с помощью предупреждения безопасности ([1](https://www.tenforums.com/tutorials/85418-how-disable-downloaded-files-being-blocked-windows.html)).|``true``|
|``disable malicious software removal tool updates``|1. Более точный контроль над функцией|Запрещает Windows предлагать средство удаления вредоносных программ через Windows Update.|``true``|
|``disable sticky keys``|1. Уменьшение или отключение навязчивых элементов|Отключает сообщение "Хотите включить залипание клавиши?" при многократном нажатии горячей клавиши. Это может быть очень навязчиво в приложениях, использующих клавишу ``Shift`` для управления, например, в играх.|``true``|
|``disable pointer acceleration``|1. Уменьшение или отключение навязчивых элементов|Обеспечивает отклик мыши в режиме один к одному в играх, которые не поддерживают необработанные события ввода, а также на Рабочем столе.|``true``|
|``disable fast startup``|1. Уменьшение или отключение навязчивых элементов|Вмешивается в процесс выключения, так как система не переходит в состояние S5, что может привести к неожиданным проблемам ([объяснение](https://www.youtube.com/watch?v=OBGxt8zhbRk)). Дополнительную информацию см. в разделе [Быстрый запуск, переход в ждущий режим и гибернация](#Быстрый-запуск,-переход-в-ждущий-режим-и-гибернация). Можно завершить работу без отключения быстрого запуска, удерживая ``Shift`` при нажатии ``Выключить`` в меню Пуск. Однако недостатком этого метода является возможность забыть удерживать клавишу ``Shift``.|``true``|
|``disable customer experience improvement program``|1. Снижение телеметрии ([1](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/jj618322(v=ws.11)))|Рекомендуется [privacyguides.org](https://www.privacyguides.org/en/os/windows/group-policies)|``true``|
|``disable windows error reporting``|1. Снижение телеметрии|Рекомендуется [privacyguides.org](https://www.privacyguides.org/en/os/windows/group-policies)|``true``|
|``disable clipboard history``|1. Снижение телеметрии|Рекомендуется [privacyguides.org](https://www.privacyguides.org/en/os/windows/group-policies)|``true``|
|``disable activity feed``|1. Снижение телеметрии|Рекомендуется [privacyguides.org](https://www.privacyguides.org/en/os/windows/group-policies)|``true``|
|``disable advertising id``|1. Снижение телеметрии|Рекомендуется [privacyguides.org](https://www.privacyguides.org/en/os/windows/group-policies)|``true``|
|``disable autoplay``|1. Снижение риска безопасности|Рекомендуется [privacyguides.org](https://www.privacyguides.org/en/os/windows/group-policies)|``true``|
|``disable cloud content``|1. Снижение телеметрии|Рекомендуется [privacyguides.org](https://www.privacyguides.org/en/os/windows/group-policies)|``true``|
|``disable account-based explorer features``|1. Снижение телеметрии|Рекомендуется [privacyguides.org](https://www.privacyguides.org/en/os/windows/group-policies)|``true``|
|``disable mdm enrollment``|1. Снижение телеметрии|Рекомендуется [privacyguides.org](https://www.privacyguides.org/en/os/windows/group-policies)|``true``|
|``disable microsoft store push to install feature``|1. Снижение риска безопасности|Рекомендуется [privacyguides.org](https://www.privacyguides.org/en/os/windows/group-policies)|``true``|
|``mitigate web-based search info``|1. Снижение телеметрии|Рекомендуется [privacyguides.org](https://www.privacyguides.org/en/os/windows/group-policies)|``true``|
|``disable sending inking and typing data to microsoft``|1. Снижение телеметрии|Рекомендуется [privacyguides.org](https://www.privacyguides.org/en/os/windows/group-policies)|``true``|
|``disable automatic maintenance``|2. Более точный контроль над функцией|N/A|``true``|
|``disable program compatibility assistant``|2. Более точный контроль над функцией|Запрещает анонимное применение изменений Windows после запуска средств устранения неполадок.|``true``|
|``disable remote assistance``|1. Снижение риска безопасности|N/A|``true``|
|``disable sign-in and lock last interactive user after a restart``|1. Снижение риска безопасности ([1](https://www.stigviewer.com/stig/windows_server_2012_2012_r2_member_server/2014-06-30/finding/V-43245))|N/A|``true``|
|``show file extensions``|1. Снижение риска безопасности ([1](https://www.youtube.com/watch?v=nYdS3FIu3rI))|N/A|``true``|
|``disable widgets``|1. Снижение риска безопасности ([1](https://www.youtube.com/watch?v=m9d-fXl3Z8k))|N/A|``true``|
|``disable telemetry``|1. Снижение телеметрии|N/A|``true``|
|``disable retrieval of online tips and help in the immersive control panel``|1. Снижение телеметрии|N/A|``true``|
|``disable typing insights``|1. Снижение телеметрии|N/A|``true``|
|``disable suggestions in the search box and in search home``|1. Снижение телеметрии<br><br>2. Уменьшение или отключение навязчивых функций|N/A|``true``|
|``disable computer is out of support message``|1. Уменьшение или отключение навязчивых элементов|Отключает [это](https://support.microsoft.com/en-us/topic/you-received-a-notification-your-windows-7-pc-is-out-of-support-3278599f-9613-5cc1-e0ee-4f81f623adcf) навязчивое сообщение. Не актуально для пользователей с современной версией Windows|``true``|
|``disable fault tolerant heap``|2. Более точный контроль над функцией|Запрещает Windows применять средства защиты для предотвращения будущих сбоев на основе каждого приложения ([1](https://learn.microsoft.com/en-us/windows/win32/win7appqual/fault-tolerant-heap)), что может привести к проблемам ([1](https://www.mak.com/mak-one/support/help/knowledge/performance-issues-caused-by-the-fault-tolerant-heap-windows)).|``true``|

- Запустите PowerShell с правами администратора (не через Win+R, и вручную это сделать не получится) и введите следующую команду:

    ```powershell
    C:\files\apply-registry.ps1
    ```

- Если команда не сработала, попробуйте отключить защиту от изменений (Tamper protection) в Windows Defender. Если это не помогло, перезагрузите систему и повторите команду.

- Если у вас возникают трудности с объединением файлов реестра, попробуйте сделать это в безопасном режиме с помощью NSudo.

- Убедитесь, что скрипт выводит сообщение "successfully applied" в консоль. Если этого не происходит, значит, файлы реестра не были успешно объединены.

## 4. Установка драйверов

>**⚠**
> Драйверы чипсета обычно не являются обязательными, но если они имеются, их функциональность можно воспроизвести вручную, что позволит избежать накладных расходов, связанных с постоянной работой драйверов и переключением контекста. Например, драйверы чипсета AMD используются для управления нагрузкой на каждый процессор при планировании потоков на V-Cache CCX/CCD. [[1](https://hwbusters.com/cpu/amd-ryzen-9-7950x3d-cpu-review-performance-thermals-power-analysis/2)].

- Драйвера чипсета Intel от Fernando: [Chipset Device "Drivers" (= INF files) | Fernando](https://winraid.level1techs.com/t/intel-chipset-device-drivers-inf-files/30920)

>**⚠**
> Драйвера чипсета Intel, предоставляемые Microsoft, не сильно отличаются от установленных вручную, по крайней мере, для процессоров до 12 поколения, так как там уже появляются E-ядра. При желании можно вручную настроить распределение нагрузки между ядрами.

- Вы можете найти драйверы, выполнив поиск драйверов, совместимых с HWID вашего устройства. Смотрите [пример](/docs/device-hwid-example.png) для поиска вашего HWID в диспетчере устройств.

- Старайтесь получать драйверы в формате INF, чтобы их можно было установить через диспетчер устройств, так как исполняемые установщики часто устанавливают вместе с драйвером дополнительные программы. В большинстве случаев драйвер можно извлечь из исполняемого файла установщика с помощью программы 7-Zip.

Рекомендуется обновить и установить следующее:

- Контроллер сетевого интерфейса
  > Если на этом этапе у вас нет доступа к интернету, вам придется загрузить драйвер сетевой карты с другого устройства или выполнить двойную загрузку, так как в некоторых версиях Windows они могут быть вообще не установлены.

    - Другие необходимые драйверы можно установить с помощью [Snappy Driver Installer Origin](https://www.snappy-driver-installer.org).

Настройка драйвера для видеокарты описана в отдельном разделе.

## 5. Промежуточная настройка некоторых аспектов

Для активации Windows воспользуйтесь следующим скриптом в ``powershell``:
```powershell
irm https://massgrave.dev/get | iex
```
- Либо примените альтернативные методы.

Настройте систему под свои предпочтения, используя ``intl.cpl`` и ``timedate.cpl`` через ``Win+R``.

Также настройте раздел ``Time & Language``, который можно открыть с помощью комбинации ``Win+I``.

Установите веб-браузер.

- Например, Firefox с настройками от амита: ``C:\files\install-firefox_by_amit.ps1``.

Установите медиаплеер, например, [VLC](https://www.videolan.org).

## 6. Установка необходимых библиотек
Установите библиотеки, которые требуются для большинства приложений:

- [Visual C++ Redistributable](https://github.com/abbodi1406/vcredist).

- [.NET 4.8](https://dotnet.microsoft.com/en-us/download/dotnet-framework/net48) (уже включен в Windows 10 версии 1909 и выше).

- [WebView](https://developer.microsoft.com/en-us/microsoft-edge/webview2).

- [DirectX](https://www.microsoft.com/en-gb/download/details.aspx?id=8109).

## 7. Настройка параметров Windows и конфигурация устройств
- Все последующие настройки можно выполнять через ``cmd``.

При желании установите максимальный срок действия пароля, чтобы он никогда не истекал, и Windows периодически запрашивала его смену или ввод ([1](https://www.tenforums.com/tutorials/87386-change-maximum-minimum-password-age-local-accounts-windows-10-a.html)).

```bat
net accounts /maxpwage:unlimited
```

Опционально отключите [зарезервированное хранилище](https://www.tenforums.com/tutorials/124858-enable-disable-reserved-storage-windows-10-a.html) (для Windows 10 версии 1903 и выше).

```bat
DISM /Online /Set-ReservedStorageState /State:Disabled
```

При желании очистите папку WinSxS для уменьшения ее размера ([1](https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/clean-up-the-winsxs-folder?view=windows-11)). Учтите, что этот процесс может занять продолжительное время.

```bat
DISM /Online /Cleanup-Image /StartComponentCleanup /ResetBase
```

Настройте название операционной системы, выбрав для него значимое или уникальное имя, например, ``Windows 11 GAMES`` или ``Windows 11 Default``. Это поможет лучше ориентироваться при использовании двойной загрузки. Также можно переименовать ярлык раздела для большей наглядности.

```bat
bcdedit /set {current} description OS_NAME
```

```bat
label C: OS_NAME
```

Если в системе отсутствует жесткий диск, вы можете отключить Superfetch/Prefetch с помощью следующей команды. Отключение SysMain упоминается в рекомендациях Microsoft по оптимизации устройств для работы в реальном времени ([1](https://learn.microsoft.com/en-us/windows/iot/iot-enterprise/soft-real-time/soft-real-time-device)).

```bat
reg add "HKLM\SYSTEM\CurrentControlSet\Services\SysMain" /v "Start" /t REG_DWORD /d "4" /f
```

Настройте следующие параметры, введя ``sysdm.cpl`` в ``Win+R``:

> **⚠**
> Отключение этих параметров не повлияет на общую производительность системы.

- В разделе ``Дополнительно`` выберите ``Производительность`` и нажмите ``Настройки`` - настройте параметры на ``Пользовательские``.

- В разделе ``Защита системы`` отключите и удалите точки восстановления, так как они могут быть ненадежными ([1](https://askleo.com/why_i_dont_like_system_restore)).

Удалите все ненужные разрешения в разделе ``Приватность``, используя комбинацию ``Win+I``.

Для пользователей Windows Server:

- В диспетчере сервера перейдите в ``Управление`` -> ``Свойства диспетчера сервера`` и активируйте опцию, запрещающую автоматический запуск диспетчера сервера.

- Установите тип запуска для служб ``Windows Audio`` и ``Windows Audio Endpoint Builder`` на автоматический, введя ``services.msc`` в ``Win+R``.

- Перейдите в ``Конфигурация компьютера`` -> ``Параметры Windows`` -> ``Параметры безопасности`` -> ``Политики учетных записей`` -> ``Политика паролей``, введя ``gpedit.msc`` в ``Win+R``, и отключите ``Пароль должен соответствовать требованиям сложности``.

- Откройте командную строку и введите ``gpupdate /force``, чтобы сразу применить изменения.

- Перейдите в ``Конфигурация компьютера`` -> ``Административные шаблоны`` -> ``Система``, введя ``gpedit.msc`` в ``Win+R``, и отключите ``Display Shutdown Event Tracker``, чтобы убрать приглашение при выключении.

- Чтобы удалить пароль пользователя, введите текущий пароль и оставьте поля для нового и подтверждения пароля пустыми в разделе ``Учетные записи пользователей``, введя ``control userpasswords`` в ``Win+R``.

## 8. Индексирование поиска
Некоторые каталоги в файловой системе индексируются для поиска в Windows. Это можно проверить, введя ``control srchadmin.dll`` в ``Win+R``. Индексирование происходит периодически в фоновом режиме и может создавать значительную нагрузку на процессор, что можно наблюдать с помощью Process Explorer. Поэтому рекомендуется отключить индексирование поиска, отключив службу Windows Search, хотя это может ограничить функции поиска. Откройте CMD с правами администратора и введите следующую команду.

```bat
reg add "HKLM\SYSTEM\CurrentControlSet\Services\WSearch" /v "Start" /t REG_DWORD /d "4" /f
```

## 9. Удаление неиспользуемого программного обеспечения

Запустите [AppxPackagesManager](https://github.com/valleyofdoom/AppxPackagesManager) и удалите все ненужные приложения (возможно, это будут все установленные пакеты). Обычно можно оставить те, которые не работают в фоновом режиме.

Необходимые пакеты для Microsoft Store. Рекомендуется оставить их, чтобы в будущем иметь возможность загружать приложения. Хотя вы можете устанавливать пакеты ``.appx`` вручную, это может быть неудобно. Дополнительные сведения можно найти [здесь](https://superuser.com/questions/1721755/is-there-a-way-to-install-microsoft-store-exclusive-apps-without-store).

- ``Microsoft.WindowsStore``

Необходимые пакеты для Xbox Game Bar. Рекомендуется сохранить этот пакет для доступа к функции ``Помните, что это игра`` в Game Bar, что поможет в решении проблем с обнаружением игр.

- ``Microsoft.XboxGamingOverlay``

Необходимые пакеты для Xbox Game Pass:

- ``Microsoft.XboxIdentityProvider``
- ``Microsoft.Xbox.TCUI``
- ``Microsoft.StorePurchaseApp``
- ``Microsoft.GamingApp``
- ``Microsoft.WindowsStore``
- ``Microsoft.GamingServices``
- ``Microsoft.XboxGamingOverlay``

Чтобы удалить OneDrive, откройте CMD и введите следующую команду:

```bat
for %a in ("SysWOW64" "System32") do (if exist "%windir%\%~a\OneDriveSetup.exe" ("%windir%\%~a\OneDriveSetup.exe" /uninstall)) && reg delete "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Desktop\NameSpace\{018D5C66-4533-4307-9B53-224DE2ED1FE6}" /f > nul 2>&1
```

Отключите Microsoft Edge на базе Chromium:

- Браузер следует отключить, а не удалить, чтобы сохранить среду выполнения WebView.

- Скачайте [Autoruns](https://learn.microsoft.com/en-us/sysinternals/downloads/autoruns) и перейдите в раздел ``Everything``, затем выполните поиск по запросу *"edge"*. Отключите все найденные элементы.

- Обновление браузера может отменить некоторые изменения, сделанные ранее. Чтобы предотвратить автоматическое обновление при случайном открытии, выполните следующую команду. Убедитесь, что в диспетчере задач не запущены скрытые процессы Microsoft Edge.

    ```bat
    rd /s /q "C:\Program Files (x86)\Microsoft\EdgeUpdate"
    ```

- Введите следующую команду в cmd, чтобы удалить все ярлыки, связанные с Edge.

    ```bat
    for /f "delims=" %a in ('where /r C:\ *edge.lnk*') do (del /f /q "%a")
    ```

- Удалите все ненужные программы, введя ``appwiz.cpl`` в ``Win+R``.

- Отключите Xbox Game Bar через настройки или с помощью следующих ключей реестра, чтобы предотвратить запуск ``GameBar.exe``.
        
    ```bat
    reg add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\GameDVR" /v "AppCaptureEnabled" /t REG_DWORD /d "0" /f
    ```

    ```bat
    reg add "HKCU\System\GameConfigStore" /v "GameDVR_Enabled" /t REG_DWORD /d "0" /f
    ```        

- В меню "Пуск" *удалите* остаточные ссылки на приложения. Учтите, что эти приложения не установлены, и они активируются только при нажатии на них, поэтому старайтесь не нажимать случайно.

- Удалите ненужные программы в разделе ``Приложения -> Установленные приложения``, нажав ``Win+I``.

- В разделе ``Система -> Дополнительные компоненты`` удалите все, что вам не нужно.

- Если Windows Defender был отключен на этапе [Объединение параметров реестра](#импортирования-настроек-в-регистр), ``smartscreen.exe`` игнорирует ключ реестра, который контролирует его постоянный запуск в фоновом режиме на более поздних версиях Windows. Поэтому откройте ``cmd`` от имени ``TrustedInstaller`` с помощью команды ``C:\bin\MinSudo.exe --TrustedInstaller --Privileged`` и введите следующую команду для удаления файла:

    ```bat
    taskkill /f /im smartscreen.exe > nul 2>&1 & ren C:\Windows\System32\smartscreen.exe smartscreen.exee
    ```

- Вы можете использовать диспетчер задач, чтобы проверить, не остались ли в фоновом режиме ненужные процессы, которые могут создавать проблемы. Если вы обнаружите такие процессы, рассмотрите возможность создания репозитория для их анализа и устранения.

Таким образом, вы сможете оптимизировать свою систему, удалив неиспользуемое программное обеспечение и отключив ненужные функции, что приведет к улучшению производительности и более чистой среде работы.

## 10. Установка 7-Zip

Скачайте и установите [7-Zip](https://www.7-zip.org). После установки откройте ``C:\Program Files\7-Zip\7zFM.exe``, затем перейдите в ``Tools -> Options`` и ассоциируйте 7-Zip со всеми типами файлов, нажав кнопку ``+``. Возможно, потребуется нажать ее дважды, чтобы отменить существующие ассоциации.

## 11. Настройка MSI Afterburner

Если вы используете [MSI Afterburner](https://www.msi.com/Landing/afterburner/graphics-cards), скачайте и установите его.

- Рекомендуется установить статическую скорость вентилятора, так как использование функции кривой вентилятора требует постоянного запуска программы.

- Чтобы автоматически загружать профиль (например, профиль 1) при старте системы, введите ``shell:startup`` в ``Win+R``, затем создайте ярлык с целью ``"C:\Program Files (x86)\MSI Afterburner\MSIAfterburner.exe" /Profile1 /Q``.

## 12. Настройки разрешения и масштабирования экрана

- Обычно у вас есть возможность выбрать масштабирование на GPU или на дисплее. Нативное разрешение не требует масштабирования, поэтому используется режим идентичного масштабирования. Это делает большинство опций масштабирования в панели управления GPU неактуальными. Если вы используете неродное разрешение, рекомендуется использовать масштабирование на дисплее, так как это снижает нагрузку на GPU.

- Стремитесь к ``actual`` целочисленной частоте обновления, например 60,00/240,00, а не 59,94/239,76. Использование параметров exact или exact reduced (приоритет отдается exact reduced) поможет достичь этого в [Custom Resolution Utility](https://www.monitortests.com/forum/Thread-Custom-Resolution-Utility-CRU).

    - Это улучшает работу лимитеров FPS и синхронизации кадров.

    - Данная настройка затрагивает только вертикальную частоту, итоговая частота монитора не изменится (как и задержка).

- Существует множество способов добиться одинакового результата в отношении масштабирования GPU и дисплея. Примеры сценариев можно найти в таблице по ссылке ниже.

    - Ознакомьтесь с [Что такое нативное масштабирование и как его можно использовать?](https://github.com/valleyofdoom/PC-Tuning/blob/main/docs/research.md#8-what-is-identity-scaling-and-how-can-you-use-it).

    - Опционально используйте [QueryDisplayScaling](https://github.com/valleyofdoom/QueryDisplayScaling), чтобы запросить текущий режим масштабирования.

- Попробуйте удалить все разрешения и лишние "мусорные" элементы (звуковые блоки), кроме родного разрешения в CRU. Это может помочь решить проблему с ~1-секундным черным экраном при переключении альт-таба во время использования ``Hardware: Legacy Flip`` в режиме отображения.

    - В системах с графическим процессором NVIDIA убедитесь, что опция ``Display`` для параметра ``Perform scaling on`` по-прежнему доступна. Если она недоступна, попробуйте выяснить, какое изменение в CRU привело к этому. Для этого запустите ``reset.exe``, чтобы сбросить настройки по умолчанию, а затем заново настройте CRU. После каждого изменения запускайте ``restart64.exe`` и проверяйте доступность опции.

    > **⚠**
    > Не рекомендуется изменять настройки масштабирования в панели управления NVIDIA.

- Убедитесь, что разрешение настроено правильно, введя ``rundll32.exe display.dll,ShowAdapterSettings`` в ``Win+R``.

- Настройте дополнительные дисплеи через настройки Windows ``Win+I`` -> ``Дисплей``. Убедитесь, что отключены опции в разделе Дополнительные дисплеи, такие как ``стереть перемещение курсора между дисплеями`` и ``минимизация отображения при отключении монитора``.

## 13. Установка Open-Shell (Опционально)

> **⚠**
> Этот раздел необходим, если были отключены важные службы и компоненты рабочего стола.

- Скачайте и установите [Open-Shell](https://github.com/Open-Shell/Open-Shell-Menu). Установите только ``Меню Open-Shell``.

Настройки:
- Общее поведение
- Отключите опцию проверки наличия обновлений Windows при выключении.

## 14. Установка Explorer Patcher (Опционально)

> **⚠**
> Этот раздел необходим, если были отключены важные службы и компоненты рабочего стола. Также позволяет вернуть меню Windows 10 на Windows 11.

- Скачайте и установите [Explorer Patcher](https://github.com/valinet/ExplorerPatcher). Убедитесь, что ваша версия Windows соответствует требованиям программы.

- После установки Explorer Patcher вы сможете настроить внешний вид и функциональность панели задач, меню "Пуск" и других элементов интерфейса, чтобы они соответствовали вашим предпочтениям.

- Ознакомьтесь с доступными настройками и измените их в соответствии с вашими нуждами, чтобы улучшить пользовательский опыт.

Таким образом, вы сможете настроить свою систему для более удобного и эффективного использования, а также вернуть некоторые функции, которые могут отсутствовать в новой версии Windows.

## 15. Spectre, Meltdown и микрокод процессора

> ⛔
> Этот раздел актуален только для Windows 10 и/или процессоров Intel (до 9 поколения включительно).

- Для отключения уязвимостей Spectre и Meltdown воспользуйтесь утилитой [InSpectre](https://www.grc.com/inspectre.htm).

    - Процессоры AMD не подвержены влиянию Meltdown. В большинстве случаев они работают лучше с активированной функцией Spectre ([1](https://www.phoronix.com/review/amd-zen4-spectrev2)).

    - Обратите внимание, что многие анти-читовые системы (например, FACEIT) требуют, чтобы Meltdown был включен.

- После внесения изменений перезагрузите компьютер и используйте функции проверки в [InSpectre](https://www.grc.com/inspectre.htm) и [CPU-Z](https://www.cpuid.com/softwares/cpu-z.html) для проверки состояния системы после перезагрузки.

## Быстрый запуск, переход в режим ожидания и спящий режим

Выбор использования функций быстрого запуска, режима ожидания и гибернации зависит от личных предпочтений и опыта. Некоторые пользователи предпочитают отключать эти функции, так как они могут вызывать неожиданные проблемы ([пояснение](https://www.youtube.com/watch?v=OBGxt8zhbRk)). Вместо этого они выбирают чистую загрузку системы, что ограничивает состояния питания до S0 (рабочее состояние) и S5 (мягкое выключение). Дополнительную информацию о состояниях питания системы можно найти [здесь](https://learn.microsoft.com/en-us/windows/win32/power/system-power-states) и [здесь](https://www.sciencedirect.com/topics/computer-science/sleeping-state). В BIOS эти опции могут называться Fast Startup, Suspend to RAM, S-States (ищите *S1*, *S2*, *S3*, *S4*, *S5*), standby или аналогичные названия. Состояние S-State можно проверить с помощью команды ``powercfg /a`` в CMD.

В Windows также есть команда, которая отключает быстрый запуск, спящий режим и удаляет файл ``C:\hiberfil.sys``:

```bat
powercfg /h off
```

## 16. Настройка параметров электропитания
> **⚠**
> Не рекомендуется для ноутбуков.

Откройте CMD и введите следующие команды.

- Установите схему ``Высокая производительность`` как активную:

    ```bat
    powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
    ```

- Удалите схему сбалансированного питания:

    ```bat
    powercfg /delete 381b4222-f694-41f0-9685-ff5bb260df2e
    ```

- Удалите схему энергосбережения:

    ```bat
    powercfg /delete a1841308-3541-4fab-bc81-f71556f20b4a
    ```

- Отключите управление питанием USB 3 Link:

    ```bat
    powercfg /setacvalueindex scheme_current 2a737441-1930-4402-8d77-b2bebba308a3 d4e98f31-5ffe-4ce1-be31-1b38b384c009 0
    ```

- Отключите выборочное приостановление USB:

    ```bat
    powercfg /setacvalueindex scheme_current 2a737441-1930-4402-8d77-b2bebba308a3 48e6b7a6-50f5-4782-a5d4-53bb8f07e226 0
    ```

- Установите минимальное количество парковки ядер процессора на 100:

    ```bat
    powercfg /setacvalueindex scheme_current 54533251-82be-4824-96c1-47b60b740d00 0cc5b647-c1df-4637-891a-dec35c318583 100
    ```

    ```bat
    powercfg /setacvalueindex scheme_current 54533251-82be-4824-96c1-47b60b740d00 0cc5b647-c1df-4637-891a-dec35c318584 100
    ```

- Установите интервал проверки времени производительности процессора на 5000:

    ```bat
    powercfg /setacvalueindex scheme_current 54533251-82be-4824-96c1-47b60b740d00 4d2b0152-7d5c-498b-88e2-34345392a2c5 5000
    ```

- Установите активную схему в качестве текущей:

    ```bat
    powercfg /setactive scheme_current
    ```

Эти настройки помогут оптимизировать параметры электропитания вашей системы, что может привести к улучшению производительности и более эффективному использованию ресурсов.

- Для примеров смотрите [media/meltdown-spectre-example.png](/docs/meltdown-spectre-example.png).

- Также ознакомьтесь с изображением [media/cpu-z-vulnerable-microcode.png](/docs/cpu-z-vulnerable-microcode.png).

## 17. Замените диспетчер задач на Process Explorer

Диспетчер задач в Windows не предоставляет достаточно полезной информации по сравнению с инструментом Process Explorer. В версиях Windows 8 и выше диспетчер задач отображает использование процессора в процентах, что может вводить в заблуждение ([1](https://aaron-margosis.medium.com/task-managers-cpu-numbers-are-all-but-meaningless-2d165b421e43)). В Windows 7 как диспетчер задач, так и Process Explorer показывают загруженность по времени, что объясняет, почему отключение состояний простоя в ОС может приводить к 100%-ной загрузке процессора в диспетчере задач.

- Скачайте и извлеките [Process Explorer](https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer).

- Скопируйте файл ``procexp64.exe`` в безопасное место, например, в директорию ``C:\Windows``, и запустите его.

- Перейдите в раздел ``Options`` и выберите ``Replace Task Manager``. При желании настройте следующие параметры:

    - Confirm Kill (Подтверждение завершения процессов)

    - Allow Only One Instance (Разрешить только один экземпляр)

    - Always On Top (Всегда поверх других окон, полезно в случае зависания приложений)

    - Включите следующие столбцы для получения более детальной информации о ресурсах:

        - Context Switch Delta (Изменение контекста - производительность процесса)

        - CPU Cycles Delta (Циклы процессора - производительность процесса)

        - Delta Reads (Чтения - ввод-вывод процесса)

        - Delta Writes (Записи - ввод-вывод процесса)

        - Delta Other (Прочие операции - ввод-вывод процесса)

    - Включите колонку ``VirusTotal`` для проверки процессов на наличие вредоносного ПО. 

Использование Process Explorer вместо стандартного диспетчера задач позволит вам получить более полное представление о работе системы и ее ресурсах.

## 18. Отключение защиты процессов

Запустите командную строку (CMD) и введите следующую команду для отключения [защиты процессов](https://docs.microsoft.com/en-us/powershell/module/processmitigations/set-processmitigation?view=windowsserver2019-ps). Чтобы просмотреть текущие настройки, используйте команду ``Get-ProcessMitigation -System`` в PowerShell.

```bat
C:\bin\disable-process-mitigations.bat
```

## 19. Настройка параметров управления памятью

- Запустите PowerShell и введите команду:

    ```powershell
    Get-MMAgent
    ```

- Примените следующую команду, чтобы отключить конкретную настройку. Если в разделе [рекомендации](#рекомендации) вы оставили активными Superfetch/Prefetch, то, вероятно, вам понадобятся функции, связанные с префетчингом:

    ```powershell
    Disable-MMAgent -MemoryCompression
    ```

## 20. Настройка звуковых устройств

- Откройте панель управления звуком, введя ``mmsys.cpl`` в окне ``Выполнить`` (Win+R).

- Отключите неиспользуемые устройства для воспроизведения и записи.

- Отключите звуковые улучшения, так как они потребляют ресурсы ([1](/docs/audio%20enhancements-benchmark.png)).

- При желании на вкладке коммуникаций выберите опцию ``Не делать ничего``, чтобы избежать автоматической регулировки уровней звука между источниками, что может раздражать пользователей ([1](https://multimedia.easeus.com/ai-article/windows-audio-ducking.html), [2](https://superuser.com/questions/1147371/how-can-i-disable-automatic-windows-7-8-10-audio-ducking)).

## 21. Настройка Диспетчера устройств

- Запустите Диспетчер устройств, введя ``devmgmt.msc`` в окне ``Выполнить`` (Win+R).

- Перейдите в меню ``Вид -> Устройства по типу``.

  - В разделе ``Дисковые накопители`` откройте ``Свойства -> Политики`` и отключите опцию очистки буфера кэша при записи для всех дисков.

  - В категории ``Сетевые адаптеры`` зайдите в ``Свойства -> Дополнительно`` и отключите все функции, связанные с энергосбережением.

- Перейдите в меню ``Вид -> Устройства по подключению``.

  - Отключите все контроллеры PCIe, SATA, NVMe и XHCI, а также USB-концентраторы, к которым ничего не подключено.

  - Отключите все устройства, кроме GPU, которые находятся на том же порту PCIe, если они вам не нужны.

- Перейдите в раздел ``Вид -> Ресурсы по подключению``.

  - Отключите все ненужные устройства, использующие IRQ или ресурсы ввода-вывода. Если у вас есть сомнения, лучше уточнить, не спешите с этим шагом.

  - Если вы видите несколько записей для одних и тех же устройств и не уверены, какое из них активно, обратитесь к древовидной структуре в ``Вид -> Устройства по подключению``. Одно устройство может использовать несколько ресурсов (например, IRQ). Вы также можете воспользоваться [MSI Utility](https://forums.guru3d.com/threads/windows-line-based-vs-message-signaled-based-interrupts-msi-tool.378044) для поиска дубликатов и ненужных устройств, если вы пропустили их в загроможденной структуре диспетчера устройств.

- При желании используйте [DeviceCleanup](https://www.uwe-sieber.de/files/DeviceCleanup.zip) для удаления скрытых устройств.

## 22. Отключение энергосбережения устройства

Запустите PowerShell и введите следующую команду, чтобы отключить опцию ``Разрешить компьютеру выключить это устройство для экономии энергии`` для всех соответствующих устройств в диспетчере устройств.

Переподключение устройств может привести к повторному включению этой опции, поэтому либо избегайте этого, выполняя команду каждый раз заново, либо создайте сценарий и запускайте его при старте системы с помощью планировщика задач ([инструкции](https://www.windowscentral.com/how-create-automated-task-using-task-scheduler-windows-10)). Убедитесь, что все пути заключены в кавычки, если они содержат пробелы. Проверьте, что все работает корректно после перезагрузки системы. Если требуются права администратора, активируйте опцию ``Запуск с наивысшими привилегиями``. Для сценариев PowerShell укажите ``PowerShell`` как программу запуска, а в качестве аргументов укажите путь к сценарию (например, ``C:\device-power-saving.ps1``).

```powershell
Get-WmiObject MSPower_DeviceEnable -Namespace root\wmi | ForEach-Object { $_.enable = $false; $_.psbase.put(); }
```

## 23. Сеансы трассировки событий (ETS)

В этом разделе представлены инструкции по массовому отключению сеансов трассировки событий. Для их просмотра введите ``perfmon`` в окне ``Выполнить`` (Win+R) и перейдите в ``Data Collector Sets -> Event Trace Sessions``. Программы, использующие трассировщики событий, не смогут собирать данные, пока необходимые сессии не будут восстановлены. Для этого создаются два файла реестра, которые позволяют переключаться между состояниями. Запустите CMD от имени администратора и введите следующие команды для создания файлов реестра в каталоге ``C:\``. Эти файлы должны быть запущены с правами Trusted Installer (используйте [NSudo](https://github.com/M2TeamArchived/NSudo/releases/latest)), чтобы избежать проблем с доступом.

- ``ets-enable.reg``

    ```bat
    reg export "HKLM\SYSTEM\CurrentControlSet\Control\WMI\Autologger" "C:\ets-enable.reg"
    ```

- ``ets-disable.reg``

    ```bat
    >> "C:\ets-disable.reg" echo Windows Registry Editor Version 5.00 && >> "C:\ets-disable.reg" echo. && >> "C:\ets-disable.reg" echo [-HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\WMI\Autologger]
    ```

- Дополнительно отключите SleepStudy (UserNotPresentSession):

    ```bat
    for %a in ("SleepStudy" "Kernel-Processor-Power" "UserModePowerService") do (wevtutil sl Microsoft-Windows-%~a/Diagnostic /e:false)
    ```

## 24. Настройка файловой системы

Запустите CMD от имени администратора и введите следующие команды.

- Отключите создание коротких имен файлов (8.3) на томах, отформатированных в FAT и NTFS.

  - См. раздел [Следует ли отключить 8dot3 для повышения производительности и безопасности?| TCAT Shelbyville](https://web.archive.org/web/20200217151754/https://ttcshelbyville.wordpress.com/2018/12/02/should-you-disable-8dot3-for-performance-and-security)

  - См. статью [Windows Short (8.3) Filenames - A Security Nightmare? | Bogdan Calin](https://www.acunetix.com/blog/articles/windows-short-8-3-filenames-web-security-problem)

    ```bat
    fsutil behavior set disable8dot3 1
    ```

- Отключите обновление метки времени последнего доступа для каталогов на томах NTFS. Отключение функции Last Access Time может повысить скорость доступа к файлам и каталогам ([1](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/fsutil-behavior#remarks)). Обратите внимание, что это может повлиять на программы резервного копирования и удаленного хранения данных, согласно официальным замечаниям ([1](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/fsutil-behavior#remarks)).

    ```bat
    fsutil behavior set disablelastaccess 1
    ```

## 25. Прерывания с сигналом сообщения (Message Signaled Interrupts, MSI)

Прерывания с сигналом сообщения (MSI) работают быстрее, чем традиционные прерывания на основе линий, и могут помочь решить проблемы с общими прерываниями, которые часто приводят к высокой задержке и нестабильности ([1](https://repo.zenk-security.com/Linux%20et%20systemes%20d.exploitations/Windows%20Internals%20Part%201_6th%20Edition.pdf)).

- Загрузите и откройте [MSI Utility](https://forums.guru3d.com/threads/windows-line-based-vs-message-signaled-based-interrupts-msi-tool.378044) или [GoInterruptPolicy](https://github.com/spddl/GoInterruptPolicy).

- MSI можно активировать на устройствах, которые его поддерживают. Обратите внимание, что разработчики могут не включать MSI в INF-файле драйвера, поэтому он будет отключен по умолчанию после установки драйвера. Например, NVIDIA может выборочно включать MSI в зависимости от архитектуры GPU ([1](https://www.nvidia.com/en-us/geforce/forums/game-ready-drivers/13/528356)). Будьте осторожны и проведите тесты, чтобы определить, приведут ли изменения к улучшению производительности.

- Чтобы проверить, использует ли устройство MSI, перезагрузите компьютер и проверьте, имеет ли данное устройство отрицательный IRQ в MSI Utility.

- Хотя этот шаг можно было пропустить в предыдущем разделе, сейчас можно оценить программные причиныразделения IRQ, убедившись, что в вашей системе нет конфликтов IRQ. Для этого введите ``msinfo32`` в окне ``Выполнить`` (Win+R) и перейдите в раздел ``Conflicts/Sharing``.

  - Если вы заметите, что устройство ``Системный таймер`` и ``Высокоточный таймер событий`` используют один и тот же IRQ (IRQ 0), решением проблемы будет отключение драйвера родительского устройства ``Системный таймер``, который является ``Мостом ISA стандарта PCI``. Это можно сделать с помощью следующей команды. Обратите внимание, что отключение ``msisadrv`` может привести к неработоспособности клавиатуры на мобильных устройствах.

    ```bat
    reg add "HKLM\SYSTEM\CurrentControlSet\Services\msisadrv" /v "Start" /t REG_DWORD /d "4" /f
    ```

После выполнения всех этих шагов рекомендуется перезагрузить систему, чтобы изменения вступили в силу. Убедитесь, что все устройства работают корректно и что производительность системы улучшилась. Если возникнут проблемы, вы всегда можете восстановить предыдущие настройки, используя созданные ранее файлы реестра.

## 26. XHCI Модерация прерываний (IMOD)

В большинстве систем с Windows 7 используется интервал IMOD в 1 мс, тогда как в более новых версиях Windows он составляет 0,05 мс (50 мкс), если это не указано в драйвере USB. Это означает, что после генерации прерывания контроллер XHCI ожидает (буферный период) в течение указанного времени, чтобы получить дополнительные данные, прежде чем сгенерировать новое прерывание. Это снижает нагрузку на процессор, но может привести к тому, что данные от устройства поступают с непостоянной скоростью, если в течение буферного периода ожидаются данные от других устройств, подключенных к тому же контроллеру XHCI.

Например, мышь с частотой опроса 1 кГц будет отправлять данные каждые 1 мс. При интервале IMOD в 1 мс модерация прерываний не будет происходить, так как прерывания генерируются со скоростью, равной или меньшей указанному интервалу. Однако в играх с высокой динамикой скорость прерываний при взаимодействии с клавиатурой и звуком может легко превысить 1000 прерываний в секунду, что может привести к потере данных при перемещении мыши, так как будет происходить ожидание данных от других устройств. Хотя при интервале IMOD в 0,05 мс (50 мкс) это маловероятно, все же возможно.

Например, интервал IMOD в 1 мс с мышью, работающей на 8 кГц, уже создает проблемы, так как данные ожидаются каждые 0,125 мс, что значительно превышает заданный интервал, что приводит к серьезным узким местам ([1](https://www.overclock.net/threads/usb-polling-precision.1550666/page-61#post-28576466)).

- Смотрите [Как постоянно отключить XHCI Interrupt Moderation | BoringBoredom](https://github.com/BoringBoredom/PC-Optimization-Hub/blob/main/content/xhci%20imod/xhci%20imod.md)

- Для загрузки драйвера [RWEverything](http://rweverything.com) может потребоваться отключение блок-листа уязвимых драйверов Microsoft с помощью следующей команды, однако в некоторых игровых античит-программах отключение блок-листа не предусмотрено (например, CS2, THE FINALS).

    ```bat
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\CI\Config" /v "VulnerableDriverBlocklistEnable" /t REG_DWORD /d "0" /f
    ```

- В некоторых случаях индекс прерывателя может измениться после перезагрузки, что приведет к недействительности жестко закодированного адреса. Чтобы обойти эту проблему, можно отключить IMOD для всех прерывателей, поместив скрипт [XHCI-IMOD-Interval.ps1](/files/XHCI-IMOD-Interval.ps1) в безопасное место и запустив его при старте системы с помощью планировщика задач ([инструкции](https://www.windowscentral.com/how-create-automated-task-using-task-scheduler-windows-10)) или используя пользовательский автозапуск ``Shell:startup``. Убедитесь, что все пути заключены в кавычки, если они содержат пробелы. Проверьте, что все работает корректно после перезагрузки системы. Если требуются права администратора, активируйте опцию ``Запуск с наивысшими привилегиями``. Для сценариев PowerShell укажите ``PowerShell`` как программу запуска, а в качестве аргументов укажите путь к сценарию (например, ``C:\XHCI-IMOD-Interval.ps1``).

    ```bat
    PowerShell C:\XHCI-IMOD-Interval.ps1
    ```

- Чтобы проверить, действует ли изменение интервала IMOD, можно временно установить интервал на ``0xFA00`` (62,5 Гц). Если при движении курсора мыши он заметно замирает, значит, изменения успешно вступили в силу.

## 27. Ограничение частоты кадров

- Установите частоту кадров, кратную частоте обновления монитора ([калькулятор](https://boringboredom.github.io/tools/fpscapcalculator)), чтобы избежать несовпадения кадров и разрывов ([1](https://www.youtube.com/watch?v=_73gFgNrYVQ), [2](https://github.com/BoringBoredom/PC- Убедитесь, что GPU не загружен на 100%, так как снижение загрузки GPU может уменьшить системную задержку ([1](https://www.youtube.com/watch?v=8ZRuFaFZh5M&t=859s), [2](https://www.youtube.com/watch?v=7CKnJ5ujL_Q)).

- Используйте [RTSS](https://www.guru3d.com/files-details/rtss-rivatuner-statistics-server-download.html) для ограничения частоты кадров вместо встроенного ограничителя в игре. Это обеспечит более стабильную частоту кадров и плавное воспроизведение, так как RTSS использует функцию busy-wait, которая обеспечивает более высокую точность по сравнению с 100% пассивным ожиданием, хотя это может привести к увеличению задержки и потенциально большей нагрузке на процессор ([1](https://www.youtube.com/watch?t=377&v=T2ENf9cigSk), [2](https://en.wikipedia.org/wiki/Busy_waiting)). Отключите параметр ``Включить службу выделенного сервера кодирования``, чтобы предотвратить запуск ``EncoderServer.exe``.

### Режим презентации

Это не рекомендация по выбору режима презентации, а информационный материал.

- Всегда проверяйте, использует ли ваша игра нужный режим презентации с помощью PresentMon ([инструкции](https://boringboredom.github.io/Frame-Time-Analysis)).

- Вы можете экспериментировать и проводить бенчмарки различных режимов презентации, чтобы определить, какой из них вам больше подходит.

  - Смотрите [Модель презентации | Wiki Special K](https://wiki.special-k.info/en/Presentation_Model)

- Если поиск двоичного имени приложения в ``HKCU\SYSTEM\GameConfigStore`` в реестре не дал результатов, возможно, вам нужно зарегистрировать игру, нажав ``Win+G`` и включив ``Remember this is a game`` во время ее работы. Проверьте, была ли создана запись под вышеупомянутым ключом реестра после завершения регистрации.

- Если вы хотите использовать режим презентации ``Hardware: Legacy Flip``, установите флажок ``Отключить полноэкранную оптимизацию``. Если это не помогло, попробуйте выполнить следующие команды в CMD и перезагрузиться. Эти ключи реестра обычно используются игрой и Windows при запуске:

    ```bat
    reg add "HKCU\SYSTEM\GameConfigStore" /v "GameDVR_DXGIHonorFSEWindowsCompatible" /t REG_DWORD /d "1" /f
    ```

    ```bat
    reg add "HKCU\SYSTEM\GameConfigStore" /v "GameDVR_FSEBehavior" /t REG_DWORD /d "2" /f
    ```

- Если вы застряли в режиме ``Hardware Composed: Independent Flip`` и хотите использовать другой режим презентации, попробуйте выполнить следующую команду, чтобы отключить MPO в CMD и перезагрузиться:

    ```bat
    reg add "HKLM\SOFTWARE\Microsoft\Windows\Dwm" /v "OverlayTestMode" /t REG_DWORD /d "5" /f
    ```

Эти шаги помогут вам оптимизировать работу системы и улучшить производительность в играх, а также минимизировать задержки и проблемы с отображением. Не забудьте протестировать изменения и убедиться, что они положительно влияют на вашу игровую среду.

## 28. Планирование в режиме ядра (прерывания, DPC и другие аспекты)

По умолчанию в Windows прерывания и DPC (Deferred Procedure Calls) назначаются на CPU 0 для ряда модулей, работающих в режиме ядра. Однако распределение множества задач на одном ядре может привести к увеличению накладных расходов и джиттера из-за конкуренции за процессорное время. Для уменьшения этих проблем можно настроить аффинити, чтобы изолировать определенные модули от помех, включая те, которые чувствительны к времени, на менее загруженных ядрах, вместо того чтобы нагружать один процессор.

- Используйте отчет xperf DPC/ISR, который создается с помощью скрипта [xperf-dpcisr.bat](/files/xperf-dpcisr.bat), чтобы выяснить, на каких ядрах работают модули режима ядра. Без этой информации вы не сможете эффективно управлять ресурсами. Аналогичный подход применим и к потокам пользовательского режима. Также проверьте, правильно ли работают политики аффинити прерываний, проанализировав использование каждого процессора для соответствующего модуля во время активности устройства.

- Контрольные показатели задержки между ядрами могут быть полезны для принятия решений по управлению аффинити.

  - Смотрите [CXWorld/MicroBenchX](https://github.com/CXWorld/MicroBenchX)

- Убедитесь, что соответствующий DPC для ISR обрабатывается на одном и том же ядре ([пример](/docs/isr-dpc-same-core.png)). Если они обрабатываются на разных ядрах, это может привести к дополнительным накладным расходам из-за увеличения межпроцессорного взаимодействия и проблем с кэшом.

- Для настройки аффинити драйверов используйте [Microsoft Interrupt Affinity Tool](https://www.techpowerup.com/download/microsoft-interrupt-affinity-tool) или [GoInterruptPolicy](https://github.com/spddl/GoInterruptPolicy). Чтобы определить устройство, проверьте ``Расположение`` в разделе ``Свойства -> Общие`` в диспетчере устройств.

### XHCI (USB контроллер) и аудиоконтроллер
Модули, связанные с XHCI и аудиоконтроллером, создают значительное количество прерываний при взаимодействии с устройствами. Изоляция этих модулей на менее загруженных ядрах может помочь снизить количество прерываний.

### Сетевая карта

Для корректной работы сетевой карты необходимо, чтобы она поддерживала MSI-X для оптимизации приема данных ([1](https://old.reddit.com/r/intel/comments/9uc03d/the_i219v_nic_on_your_new_z390_motherboard_and)). В большинстве случаев базового процессора RSS достаточно для обработки DPC и ISR драйвера сетевой карты, что устраняет необходимость в политике аффинити прерываний. Однако, если возникают проблемы с распределением нагрузки на другие ядра, стоит попробовать настроить оба.

Ниже приведена команда для настройки базового процессора RSS. Убедитесь, что ключ драйвера соответствует вашей сетевой карте. Помните, что количество очередей RSS определяет количество последовательных CPU, на которых будет работать сетевой драйвер. Например, если для базового CPU RSS установлено значение 2 и настроено 4 очереди RSS, драйвер будет запланирован на CPU 2/3/4/5 (или 2/4/6/8 с включенным HT/SMT).

- Смотрите [Сколько очередей RSS вам нужно?](https://github.com/valleyofdoom/PC-Tuning/blob/main/docs/research.md#4-how-many-rss-queues-do-you-need)

- Смотрите [assets/images/find-driver-key-example.png](/docs/find-driver-key-example.png), чтобы получить правильный ключ драйвера в диспетчере устройств.

    ```bat
    reg add "HKLM\SYSTEM\CurrentControlSet\Control\Class\{4d36e972-e325-11ce-bfc1-08002be10318}\0000" /v "*RssBaseProcNumber" /t REG_SZ /d "6" /f
    ```

- Если RSS работает не так, как ожидалось, смотрите [это](https://github.com/djdallmann/GamingPCSetup/blob/master/CONTENT/RESEARCH/NETWORK/README.md#q-my-onboard-network-adapter-i225-v-supports-rss-msi-and-msi-x-but-why-is-my-indirection-table-missing-that-gives-proper-support-for-rss-in-microsoft-windows) для возможных обходных путей.

## 29. Планирование в пользовательском режиме (процессы и потоки)

Существует несколько способов установки аффинити для процессов. Один из них — использование диспетчера задач, однако это решение временное и сохраняется только до завершения процесса. Более распространенным и постоянным вариантом является использование [Process Lasso](https://bitsum.com), который позволяет сохранить конфигурацию, но требует, чтобы программа работала в фоновом режиме, что может создавать небольшие накладные расходы. Чтобы избежать этого, вы можете запускать приложение с заранее заданным сродством процессора, что избавит вас от необходимости использовать такие программы, как Process Lasso, и повысит удобство использования.

- Используйте [CPU Affinity Mask Calculator](https://bitsum.com/tools/cpu-affinity-calculator), чтобы определить нужную битовую маску аффинити.

- В некоторых случаях процесс может быть защищен, и установка аффинити может не сработать. Чтобы обойти это ограничение, попробуйте установить аффинити для родительских процессов, что позволит дочерним процессам унаследовать это сродство. Например, программа, запускающая игры, обычно является родительским процессом для самой игры. Для определения родительских и дочерних процессов можно использовать дерево процессов в [Process Explorer](https://learn.microsoft.com/en-us/sysinternals/downloads/process-explorer).

  - [Process Hacker](https://processhacker.sourceforge.io) и [WindowsD](https://github.com/katlogic/WindowsD) могут обойти некоторые защитные механизмы на уровне процессов с помощью эксплойтов, но их использование не рекомендуется, так как это может нарушить работу античитов.

- Также стоит проверить, как масштабируется производительность вашего приложения в зависимости от количества ядер, так как оно может вести себя по-разному из-за неэффективного планирования как в приложении, так и в операционной системе. В некоторых случаях приложение может работать лучше с меньшим количеством назначенных ядер, используя маску аффинити ([1](https://developer.nvidia.com/blog/limiting-cpu-threads-for-better-game-performance)). Это также даст вам представление о том, сколько ядер можно зарезервировать. В других случаях это может негативно сказаться на производительности, так как игра может создавать больше рабочих потоков, чем доступно процессоров, учитывая только количество физических ядер, поэтому важно проводить измерения производительности.

Ниже приведена команда для запуска `notepad.exe` с аффинити на CPU 1 и CPU 2, что будет видно в диспетчере задач. Эту команду можно сохранить в bat-скрипт для быстрого доступа и использования при каждом запуске нужного приложения с заданным сродством.

```bat
start /affinity 0x6 notepad.exe
```

- Иногда процессы, для которых вы хотите установить маску аффинити, уже запущены, и предыдущая команда не будет применима. В качестве примера ниже приведена команда, устанавливающая маску аффинити для процессов `svchost.exe` и `audiodg.exe` на CPU 3. Используйте этот пример для создания сценария PowerShell, который можно запустить при старте системы с помощью Task Scheduler ([инструкции](https://www.windowscentral.com/how-create-automated-task-using-task-scheduler-windows-10)) или через пользовательский автозапуск `Shell:startup`. Убедитесь, что все пути заключены в кавычки, если они содержат пробелы. Проверьте, что все работает корректно после перезагрузки системы. Если требуются привилегии администратора, включите опцию `Запуск с наивысшими привилегиями`. Для сценариев PowerShell установите для запуска программы значение `PowerShell`, а в качестве аргументов укажите путь к сценарию (например, `C:\process-affinities.ps1`).

```powershell
Get-Process @("svchost", "audiodg") -ErrorAction SilentlyContinue | ForEach-Object { $_.ProcessorAffinity=0x8 }
```

Эти рекомендации помогут оптимизировать планирование процессов и потоков в Windows, что может привести к улучшению производительности системы и снижению задержек.

## 30. Зарезервированные наборы процессоров

[ReservedCpuSets](https://github.com/valleyofdoom/ReservedCpuSets) можно использовать для предотвращения назначения Windows ISR, DPC и других потоков на определенные ядра. Изоляция модулей от помех как на уровне пользователя, так и на уровне ядра помогает снизить количество конфликтов и джиттера, а также обеспечивает чувствительным ко времени модулям необходимое процессорное время.

- Как упоминалось в разделе [Планирование в пользовательском режиме (процессы, потоки)](#планирование-в-пользовательском-режиме-процессы-потоки), важно определить, насколько производительность вашего приложения зависит от количества ядер, чтобы понять, сколько ядер можно зарезервировать.

- Поскольку политики аффинити прерываний, аффинити процессов и потоков имеют более высокий приоритет, их можно комбинировать с пользовательскими аффинити, чтобы гарантировать, что на зарезервированных процессорах не будет запланировано ничего, кроме назначенных вами задач.

- Убедитесь, что у вас достаточно ядер для работы приложений в реальном времени, и не резервируйте слишком много процессоров, чтобы изолированные модули могли обеспечивать необходимую производительность.

- Поскольку наборы процессоров рассматриваются как мягкие политики, их конфигурация не является гарантированной. Процесс, требующий интенсивного использования процессора, например стресс-тест, может использовать зарезервированные ядра, если это необходимо.

### Примеры использования резервации ядер

- Резервирование процессоров может служить подсказкой для ОС при планировании задач на определенной группе ядер. Например, на современных платформах можно зарезервировать E-Core (эффективные ядра) или CCX/CCD, чтобы задачи по умолчанию планировались на P-Core (производительные ядра) или другие CCX/CCD. Это позволяет явно назначить фоновые и менее важные задачи на зарезервированные процессоры. Однако стоит учитывать, что некоторые процессы и модули, чувствительные к задержкам, могут не подчиняться этим политикам, что является серьезным ограничением. Важно тщательно взвесить все возможности и компромиссы, так как производительность может снижаться при резервировании E-Core или других CCX/CCD, поскольку приложения могут их использовать. Поэтому необходимо проводить измерения производительности при резервировании ядер, будь то одно, несколько или целый набор процессоров. Также стоит отметить, что планировщик или приложения могут целенаправленно использовать зарезервированные ядра для выполнения задач, если поле `RealTime` установлено в 1 в структуре [SYSTEM_CPU_SET_INFORMATION](https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-system_cpu_set_information).

- Резервирование процессоров, на которых назначены определенные модули.

## 31. Анализ журнала событий

Этот шаг не является обязательным, но может помочь в выявлении необъяснимых проблем с производительностью. Проверьте наличие ошибок в Event Viewer, введя `eventvwr.msc` в `Win+R`, так как изменения в операционной системе могут периодически вызывать внутренние ошибки или исключения.

- Объедините файл `ets-enable.reg`, созданный в разделе [Сеансы трассировки событий (ETS)](#сеансы-трассировки-событий-ets), если это необходимо, так как он требуется для регистрации событий.

## 32. Безопасность на основе виртуализации (VBS)

Virtualization Based Security может негативно сказываться на производительности ([1](https://www.tomshardware.com/news/windows-11-gaming-benchmarks-performance-vbs-hvci-security)), и в некоторых случаях она включена по умолчанию. Чтобы проверить ее статус, введите `msinfo32` в `Win+R`, и при необходимости отключите ([1](https://www.tomshardware.com/how-to/disable-vbs-windows-11), [2](https://support.microsoft.com/en-us/windows/options-to-optimize-gaming-performance-in-windows-11-a255f612-2949-4373-a566-ff6f3f474613)). С другой стороны, [privacyguides.org](https://www.privacyguides.org/en/os/windows/group-policies/) рекомендует оставлять эту функцию включенной.

## 33. Зарезервированные наборы процессоров

[ReservedCpuSets](https://github.com/valleyofdoom/ReservedCpuSets) можно использовать для предотвращения назначения Windows ISR, DPC и других потоков на определенные ядра. Изоляция модулей от помех как на уровне пользователя, так и на уровне ядра помогает снизить количество конфликтов и джиттера, а также обеспечивает чувствительным ко времени модулям необходимое процессорное время.

- Как упоминалось в разделе [Планирование в пользовательском режиме (процессы, потоки)](#планирование-в-пользовательском-режиме-процессы-потоки), важно определить, насколько производительность вашего приложения зависит от количества ядер, чтобы понять, сколько ядер можно зарезервировать.

- Поскольку политики аффинити прерываний, аффинити процессов и потоков имеют более высокий приоритет, их можно комбинировать с пользовательскими аффинити, чтобы гарантировать, что на зарезервированных процессорах не будет запланировано ничего, кроме назначенных вами задач.

- Убедитесь, что у вас достаточно ядер для работы приложений в реальном времени, и не резервируйте слишком много процессоров, чтобы изолированные модули могли обеспечивать необходимую производительность.

- Поскольку наборы процессоров рассматриваются как мягкие политики, их конфигурация не является гарантированной. Процесс, требующий интенсивного использования процессора, например стресс-тест, может использовать зарезервированные ядра, если это необходимо.

### Примеры использования резервации ядер

- Резервирование процессоров может служить подсказкой для ОС при планировании задач на определенной группе ядер. Например, на современных платформах можно зарезервировать E-Core (эффективные ядра) или CCX/CCD, чтобы задачи по умолчанию планировались на P-Core (производительные ядра) или другие CCX/CCD. Это позволяет явно назначить фоновые и менее важные задачи на зарезервированные процессоры. Однако стоит учитывать, что некоторые процессы и модули, чувствительные к задержкам, могут не подчиняться этим политикам, что является серьезным ограничением. Важно тщательно взвесить все возможности и компромиссы, так как производительность может снижаться при резервировании E-Core или других CCX/CCD, поскольку приложения могут их использовать. Поэтому необходимо проводить измерения производительности при резервировании ядер, будь то одно, несколько или целый набор процессоров. Также стоит отметить, что планировщик или приложения могут целенаправленно использовать зарезервированные ядра для выполнения задач, если поле `RealTime` установлено в 1 в структуре [SYSTEM_CPU_SET_INFORMATION](https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-system_cpu_set_information).

- Резервирование процессоров, на которых назначены определенные модули.

## 34. Анализ журнала событий

Этот шаг не является обязательным, но может помочь в выявлении необъяснимых проблем с производительностью. Проверьте наличие ошибок в Event Viewer, введя `eventvwr.msc` в `Win+R`, так как изменения в операционной системе могут периодически вызывать внутренние ошибки или исключения.

- Объедините файл `ets-enable.reg`, созданный в разделе [Сеансы трассировки событий (ETS)](#сеансы-трассировки-событий-ets), если это необходимо, так как он требуется для регистрации событий.

## 35. Безопасность на основе виртуализации (VBS)

Virtualization Based Security может негативно сказываться на производительности ([1](https://www.tomshardware.com/news/windows-11-gaming-benchmarks-performance-vbs-hvci-security)), и в некоторых случаях она включена по умолчанию. Чтобы проверить ее статус, введите `msinfo32` в `Win+R`, и при необходимости отключите ([1](https://www.tomshardware.com/how-to/disable-vbs-windows-11), [2](https://support.microsoft.com/en-us/windows/options-to-optimize-gaming-performance-in-windows-11-a255f612-2949-4373-a566-ff6f3f474613)). С другой стороны, [privacyguides.org](https://www.privacyguides.org/en/os/windows/group-policies/) рекомендует оставлять эту функцию включенной.

## Состояния простоя процессора

Отключение состояний простоя приводит к переходу в состояние C-State 0, что можно наблюдать с помощью [HWiNFO](https://www.hwinfo.com), а также в рекомендациях Microsoft по настройке устройств для работы в реальном времени ([1](https://learn.microsoft.com/en-us/windows/iot/iot-enterprise/soft-real-time/soft-real-time-device)). Принудительное включение C-State 0 уменьшает нежелательную задержку выполнения новых инструкций на процессоре, который перешел в более глубокие энергосберегающие состояния, но это может привести к повышению температуры и энергопотребления. Поэтому большинству пользователей рекомендуется оставить состояния простоя включенными, так как побочные эффекты могут вызвать другие проблемы, такие как дросселирование и сбои в питании. Температура процессора не должна превышать уровень теплового дросселирования.

Если статическая частота процессора не задана, следует оценить эффект от отключения состояния C-State 0 с точки зрения поведения при повышении частоты. Например, не стоит отключать состояния простоя, если вы полагаетесь на функции, такие как Precision Boost Overdrive (PBO), Turbo Boost или аналогичные технологии. Также рекомендуется избегать отключения состояний простоя при включенной Hyper-Threading/Simultaneous Multithreading, так как это может негативно сказаться на производительности однопоточных приложений.

### Включение состояний простоя (по умолчанию)

```bat
powercfg /setacvalueindex scheme_current sub_processor 5d76a2ca-e8c0-402f-a133-2158492d58ad 0 && powercfg /setactive scheme_current
```

### Отключение состояния простоя

```bat
powercfg /setacvalueindex scheme_current sub_processor 5d76a2ca-e8c0-402f-a133-2158492d58ad 1 && powercfg /setactive scheme_current
```

## 36. Квантование и планирование потоков

Квант — это период времени, в течение которого поток может выполняться, прежде чем планировщик оценит, не запланирован ли другой поток с тем же приоритетом. Если поток завершает свой квант, а другие потоки с его приоритетом не готовы к выполнению, планировщик позволяет этому потоку продолжить работу еще на один квант. Квант можно контролировать с помощью следующего ключа реестра, а также можно определить, сколько времени из кванта отводится фоновым и фоновым потокам. Значение представлено в виде 6-битной битовой маски, где каждая пара битов определяет характеристики кванта и распределение времени между фоновыми и фоновыми потоками. По умолчанию установлено значение `0x2`, что соответствует `0b000010`, и имеет разные значения в клиентской и серверной версиях, о чем будет рассказано ниже.

```
[HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Control\PriorityControl]
"Win32PrioritySeparation"=dword:00000002
```

Изменение этого значения может повлиять на поведение планировщика и, соответственно, на производительность приложений. Например, увеличение значения может привести к более агрессивному распределению времени между потоками, что может быть полезно для приложений с высоким приоритетом, но может также негативно сказаться на производительности фоновых задач.

Важно помнить, что любые изменения в настройках системы должны быть тщательно протестированы, чтобы убедиться, что они действительно улучшают производительность, а не ухудшают ее. Рекомендуется делать резервные копии текущих настроек перед внесением изменений, чтобы в случае необходимости можно было легко восстановить прежние параметры.

### Объяснение битовой маски

- Самая левая пара битов (**XX**YYZZ) определяет длину кванта и представлена как `PspForegroundQuantum`.

  | Значение | Описание |
  |---|---|
  | 00/11 | Короткие интервалы (клиент Windows), длинные интервалы (сервер Windows) |
  | 01 | Длинные интервалы |
  | 10 | Короткие интервалы |

- Средняя пара битов (XX**YY**ZZ) указывает, является ли длина кванта переменной или фиксированной. Если используется квант фиксированной длины, то крайняя правая битовая пара игнорируется, так как соотношение, определяющее время, выделяемое фоновым и передним потокам в пределах кванта, фиксировано. Это представлено как `PspForegroundQuantum`.

  | Значение | Описание |
  |---|---|
  | 00/11 | Переменная длина (клиент Windows), фиксированная длина (сервер Windows) |
  | 01 | Переменная длина |
  | 10 | Фиксированная длина |

- Крайняя правая пара битов (XXYY**ZZ**) определяет соотношение времени в кванте, выделяемого фоновым и передним потокам. Передним потокам может быть выделено в три раза больше процессорного времени, чем фоновым. Это можно настроить только с квантами переменной длины и представлено функцией `PsPrioritySeparation`.

  | Значение | Описание |
  |---|---|
  | 00 | 1:1 |
  | 01 | 2:1 |
  | 10/11 | 3:1 |

- Исходя из приведенной информации, значение по умолчанию `0x2` соответствует короткому, переменной длины, 3:1 на клиенте Windows и длинному, фиксированной длины, 3:1 на сервере Windows.

Эта битовая маска позволяет гибко настраивать поведение планировщика, что может быть полезно для оптимизации производительности приложений в зависимости от их требований к ресурсам. Понимание этих параметров может помочь в более точной настройке системы для достижения наилучших результатов в различных сценариях использования.

### Значения Win32PrioritySeparation

Приведенная ниже таблица содержит все возможные значения, соответствующие клиентским и серверным редакциям Windows. Значения `00` или `11` не использовались в битовой маске **XXYY**ZZ, которая имеет разные значения для клиентских и серверных версий. Любое значение, не указанное в таблице, идентично тому, что указано в таблице, как объяснено [здесь](https://github.com/valleyofdoom/PC-Tuning/blob/main/docs/research.md#5-ambiguous-win32priorityseparation-values-explained). Поэтому значения в таблице являются единственными, которые следует использовать. Время в миллисекундах основано на разрешении таймера современных мультипроцессоров x86/x64.

Хотя повышение приоритета переднего плана не может быть использовано при фиксированной длине кванта, значение `PsPrioritySeparation` все равно изменяется, и механизм повышения приоритета другого потока использует его значение. Таким образом, фиксированный квант 3:1 должен иметь ощутимую разницу по сравнению с фиксированным квантом 1:1. Как указано в Windows Internals:

> Каждый раз, когда поток в процессе переднего плана завершает операцию ожидания над объектом ядра, ядро повышает его текущий (не базовый) приоритет на текущее значение `PsPrioritySeparation`. Оконная система отвечает за определение того, какой процесс считается находящимся на переднем плане. `PsPrioritySeparation` отражает индекс таблицы квантов, используемый для выбора квантов для потоков приложений переднего плана. Однако в данном случае он используется как значение повышения приоритета.

Для большинства пользователей рекомендуется оставить значение по умолчанию. Хотя сочетание длины кванта и соотношения распределения времени между передними и задними потоками может влиять на частоту переключения контекста, вы можете проверить, как это влияет на производительность в ваших приложениях, если хотите. Если вы используете Windows Server на настольной системе, значение может быть установлено в `0x26`, что имитирует поведение `0x2` в клиентских версиях Windows.

| **Шестнадцатеричное** | **Десятичное** | **Двоичное** | **Интервал** | **Длина** | **PsPrioSep** | **ПереднийКв** | **ЗаднийКв** | **ОбщийКв** |
|---|---|---|---|---|---|---|---|---|
| 0x14 | 20 | 0b010100 | Длинный | Переменный | 0 | 12 (62.50ms) | 12 (62.50ms) | 24 (125.00ms) |
| 0x15 | 21 | 0b010101 | Длинный | Переменный | 1 | 24 (125.00ms) | 12 (62.50ms) | 36 (187.50ms) |
| 0x16 | 22 | 0b010110 | Длинный | Переменный | 2 | 36 (187.50ms) | 12 (62.50ms) | 48 (250.00ms) |
| 0x18 | 24 | 0b011000 | Длинный | Фиксированный | 0 | 36 (187.50ms) | 36 (187.50ms) | 72 (375.00ms) |
| 0x19 | 25 | 0b011001 | Длинный | Фиксированный | 1 | 36 (187.50ms) | 36 (187.50ms) | 72 (375.00ms) |
| 0x1A | 26 | 0b011010 | Длинный | Фиксированный | 2 | 36 (187.50ms) | 36 (187.50ms) | 72 (375.00ms) |
| 0x24 | 36 | 0b100100 | Короткий | Переменный | 0 | 6 (31.25ms) | 6 (31.25ms) | 12 (62.50ms) |
| 0x25 | 37 | 0b100101 | Короткий | Переменный | 1 | 12 (62.50ms) | 6 (31.25ms) | 18 (93.75ms) |
| 0x26 | 38 | 0b100110 | Короткий | Переменный | 2| 0x26 | 38 | 0b100110 | Короткий | Переменный | 2 | 18 (93.75ms) | 6 (31.25ms) | 24 (125.00ms) |
| 0x28 | 40 | 0b101000 | Короткий | Фиксированный | 0 | 18 (93.75ms) | 18 (93.75ms) | 36 (187.50ms) |
| 0x29 | 41 | 0b101001 | Короткий | Фиксированный | 1 | 18 (93.75ms) | 18 (93.75ms) | 36 (187.50ms) |
| 0x2A | 42 | 0b101010 | Короткий | Фиксированный | 2 | 18 (93.75ms) | 18 (93.75ms) | 36 (187.50ms) |

Эта таблица демонстрирует, как различные значения `Win32PrioritySeparation` влияют на распределение времени выполнения между передними и задними потоками в Windows. Каждое значение определяет, как долго потоки могут выполняться, прежде чем планировщик оценит, не следует ли переключить контекст на другой поток с тем же приоритетом.

Важно отметить, что выбор правильного значения может существенно повлиять на производительность приложений, особенно в сценариях с высокой нагрузкой на процессор. Например, использование длинных квантов с фиксированным соотношением может быть полезно для приложений, требующих стабильной производительности, в то время как короткие кванты могут быть более подходящими для интерактивных приложений, где важна отзывчивость.

Рекомендуется тестировать различные настройки в зависимости от специфики ваших приложений и рабочих нагрузок, чтобы найти оптимальное значение для вашей системы.

### Рекомендации

На основе проведенных тестов и экспериментов было установлено, что параметр Win32PrioritySeparation не оказывает прямого влияния на производительность и задержку. Чтобы помочь вам выбрать оптимальное значение, я добавлю некоторые пояснения, используя термин EXO(_iiiexoiii_):

**EXO**: Для достижения максимальной стабильности и обеспечения приоритета важным системным процессам, не выделяя слишком много времени "активному приложению" (т.е. тому, что отображается на экране), необходимо полностью отключить FG буст. Это подразумевает установку значения PsPrioritySeparation на 0 (без буста, 1:1).

Если же выбрать фиксированные значения 3:1 или 2:1, то, хотя в windbg видно, что BG и FG процессы имеют одинаковое значение Quantum (QuantumReset можно проверить в windbg, где они получают равное количество времени процессора), согласно внутренним механизмам Windows, значение PsPrioritySeparation будет задействовано в другом механизме буста (приоритет потока +1/+2 к "текущему приоритету" переднего плана, а не базовому приоритету).

Таким образом, следует выбирать только те значения, где PsPrioritySeparation равно 0: ``0x14``, ``0x18``, ``0x24``, ``0x28``.

Для ``0x14`` и ``0x24`` длина является переменной, но поскольку PsPrioritySeparation равен 0, это не имеет значения.

Теперь необходимо определиться с интервалом: **длинный** или **короткий**. Значение квантума определяет, сколько времени выделяется потоку до переключения на другой поток с тем же приоритетом. Если время небольшое, система быстрее переключится на другой поток, который требует времени, что теоретически улучшит отзывчивость, но увеличит количество переключений контекста.

Из нашего списка: ``0x14``, ``0x18``, ``0x24``, ``0x28`` - наименьшие интервалы у ``0x24``. Если **переменная длина** не влияет на значение PsPrioritySeparation 0, как указывает windbg, то оптимальным значением будет ``0x24`` (в шестнадцатеричном формате).

*(Однако, если вы хотите минимизировать количество переключений контекста, не используя **буст потока переднего плана**, лучше выбрать ``0x18``)*.

**UPD**: Это не заставляет потоки с высоким приоритетом ожидать (например, системные потоки, отвечающие за ввод, такие как потоки ``csrss`` и ``dwm``), поскольку потоки с приоритетом ``Realtime`` игнорируют значение квантума и могут приостановить **любой** поток с более низким приоритетом (например, поток игры может быть приостановлен потоком ``csrss``). Значение квантума будет иметь значение только в конкуренции потоков игры между собой, так как у них в основном одинаковый приоритет. В этом случае значение квантума может применяться, но это маловероятно, поскольку поток обычно приостанавливается или выполняет свою работу до достижения значения квантума. Таким образом, значение квантума не имеет большого значения, но буст приоритета потока важен, хотя конкуренция потоков одного приоритета (``Priority_Class`` и приоритеты потоков) также имеет значение, и большинство важных потоков имеют приоритет выше, чем "приложение переднего плана" (игра), что делает влияние этого параметра преувеличенным, и, возможно, буст стоит оставить.

Если вы предпочитаете вручную настраивать приоритеты потоков игры, помните о том, что я описал, так как если вы установите процессу игры такой же приоритет (``Priority_Class`` - ``Realtime``), как у процесса ``CSRSS``, поток ввода ``CSRSS`` не сможет остановить поток игры (но это требует тестирования). Также при ручной настройке вам может не понравиться динамический буст приоритета у потоков игры.

## 37. Частота прерываний системного таймера (разрешение таймера)

Частота прерываний - это частота, с которой системный таймер генерирует прерывания, позволяя планировщику выполнять различные задачи, такие как хронометраж. В большинстве систем минимальная частота по умолчанию составляет 64 Гц, что означает, что прерывание генерируется каждые 15,625 мс. Более низкая частота снижает нагрузку на процессор и энергопотреблениеза счет уменьшения количества прерываний, но это также снижает точность синхронизации и может привести к менее отзывчивой многозадачности. Максимальная частота составляет 2 кГц, что означает, что прерывание генерируется каждые 0,5 мс. Более высокая частота обеспечивает большую точность синхронизации и потенциально улучшает скорость отклика многозадачной системы, но увеличивает нагрузку на процессор и потребление энергии. Минимальное, текущее и максимальное разрешение можно проверить с помощью утилиты [ClockRes](https://learn.microsoft.com/en-us/sysinternals/downloads/clockres).

Приложения, которым требуется более высокая точность, чем стандартное разрешение 15,625 мс, могут повысить частоту прерываний с помощью функций, таких как [timeBeginPeriod](https://learn.microsoft.com/en-us/windows/win32/api/timeapi/nf-timeapi-timebeginperiod) и [NtSetTimerResolution](http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FTime%2FNtSetTimerResolution.html). Обычно это необходимо для мультимедийных приложений, игр, VoIP и других сценариев, что можно увидеть, запустив трассировку энергопотребления ([инструкции](https://support.microsoft.com/en-gb/topic/guided-help-get-a-detailed-power-efficiency-diagnostics-report-for-your-computer-in-windows-7-3f6ce138-fc04-7648-089a-854bcf332810)) во время работы. Точность функций, зависящих от режима сна для отслеживания событий, напрямую зависит от частоты прерываний ([1](https://randomascii.wordpress.com/wp-content/uploads/2020/10/image-5.png)). Например, функция [Sleep](https://learn.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-sleep) должна обеспечивать паузу в течение n миллисекунд, а не n плюс/минус произвольное значение, иначе это может привести к непредсказуемым и нестабильным темпам событий, что нежелательно для таких функций, как ограничители частоты кадров на основе сна. Обратите внимание, что это лишь пример, и многие реальные приложения не полагаются исключительно на функцию ``Sleep`` для отслеживания событий. Обычно разработчики поднимают разрешение до 1 мс, что позволяет приложению поддерживать темп событий в пределах этого разрешения. В редких случаях разработчики могут не повышать разрешение, полагаясь на него для точности темпа событий, что может привести к сбоям, но это встречается нечасто и может касаться некоторых малоизвестных программ, таких как не очень популярные игры.

Реализация разрешения таймера была изменена в Windows 10 версии 2004 и выше, так что процесс, повышающий разрешение, не влияет на систему в глобальном масштабе. То есть, если процесс A повышает разрешение до 1 мс, это не затрагивает процесс B, который работает с разрешением по умолчанию 15,625 мс, как это было раньше. Это изменение значительно снижает накладные расходы, так как другие процессы, такие как фоновые, не обслуживаются планировщиком так часто, а вызывающий процесс получает более высокую точность по мере необходимости. Однако для конечного пользователя это создает ограничения при желании использовать более высокие разрешения, например, 0,5 мс. Поскольку игры не имеют открытого исходного кода для модификации, а также существуют ограничения античита, препятствующие внедрению DLL или изменению бинарных файлов для повышения разрешения выше 1 мс в рамках каждого процесса, единственным вариантом остается использование глобального поведения, которое можно настроить с помощью следующего ключа реестра в Windows Server 2022 и Windows 11 и выше, как подробно описано [здесь](https://github.com/valleyofdoom/PC-Tuning/blob/main/docs/research.md#6-fixing-timing-precision-in-windows-after-the-great-rule-change).

```
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\kernel]
"GlobalTimerResolutionRequests"=dword:00000001
```

Это позволяет повышать разрешение в отдельном процессе, что, в свою очередь, дает нужному приложению, например игре, более высокую точность. **Тем не менее, как уже упоминалось, внедрение в каждый процесс снижает накладные расходы, чего не происходит при восстановлении глобального поведения, и фоновые процессы также обслуживаются неоправданно часто.** Альтернативным методом ограничения частительности кадров является [RTSS](https://www.guru3d.com/download/rtss-rivatuner-statistics-server-download), который использует гибридное ожидание, обеспечивая более высокую точность и устраняя необходимость в восстановлении глобального поведения.

Более высокое разрешение обеспечивает большую точность, но в некоторых случаях максимальное поддерживаемое разрешение 0,5 мс может давать меньшую точность, чем немного меньшее значение, например 0,507 мс ([1](https://github.com/valleyofdoom/PC-Tuning/blob/main/docs/research.md#7-micro-adjusting-timer-resolution-for-higher-precision)). Поэтому имеет смысл определить, какое разрешение вызова обеспечивает наибольшую точность (наименьшие дельты) в программе [MeasureSleep](https://github.com/valleyofdoom/TimerResolution), а также протестировать различные разрешения с помощью программы [SetTimerResolution](https://github.com/valleyofdoom/TimerResolution). Это следует делать под нагрузкой, так как тесты в бездействии могут вводить в заблуждение. Для автоматизации процесса можно использовать скрипт [micro-adjust-benchmark.ps1](https://github.com/valleyofdoom/TimerResolution).

В заключение, я рекомендую отдавать предпочтение реализации на уровне каждого процесса (неглобальной), где это возможно, так как это снижает накладные расходы. Вместо этого используйте [RTSS](https://www.guru3d.com/download/rtss-rivatuner-statistics-server-download) для точного ограничения частоты кадров. Следует отметить, что это может вносить заметно большую задержку ([1](https://www.youtube.com/watch?t=377&v=T2ENf9cigSk), [2](https://en.wikipedia.org/wiki/Busy_waiting)), поэтому я рекомендую сравнивать и тестировать его с микрорегулировкой запрашиваемого разрешения для достижения большей точности при глобальном поведении. Возможно, что повышение разрешения выше 1 мс не влияет на стабильность частоты кадров из-за улучшений во встроенных ограничителях частоты кадров в играх, и в этом случае никаких действий предпринимать не нужно. **Главное, что я хочу донести до вас, - это сравнить все доступные варианты, отдав предпочтение поведению для каждого процесса, которое используется по умолчанию в Windows 10 версии 2004 и выше, если вы обнаружите, что дальнейшее повышение разрешения практически не влияет на ситуацию.**

### Сериализация окончания таймера (SerializeTimerExpiration)

**EXO**: В Windows 11 версии 24h2 параметр ``SerializeTimerExpiration`` функционирует следующим образом:

- При установке ``SerializeTimerExpiration`` на ``1`` (при условии, что приложение вызывает таймер с интервалом 0,5 мс):
  - Интервал между прерываниями системного таймера на **ядре 0** составляет 0,495-0,500 мс, в то время как на **остальных ядрах** этот интервал равен 1,7 мс.

- При установке ``SerializeTimerExpiration`` на ``2`` (при условии, что приложение вызывает таймер с интервалом 0,5 мс):
  - Интервал между прерываниями системного таймера на всех ядрах составляет 0,495-0,500 мс.

- При установке ``SerializeTimerExpiration`` на ``0``:
  - Значение выбирается автоматически в зависимости от доступности ``MODERN STANDBY`` (в большинстве случаев это будет эквивалентно значению ``1``, если такая возможность доступна).

Таким образом, при установке значения ``2`` вы лишь увеличиваете нагрузку на все ядра вместо одного (ядро 0) ради минимального улучшения точности системного таймера. Судя по всему, прерывания системного таймера со всех ядер будут обновлять системное время/часы, а не только прерывания с **ядра 0**, что происходит асинхронно.

```
[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\kernel]
"SerializeTimerExpiration"=dword:00000000
```

### О Tickless kernel (параметры Bcd store)

- ``UsePlatformTick`` - Microsoft: *Заставляет систему использовать платформный таймер, исключая синтетические таймеры. Эта опция доступна начиная с Windows 8 и Windows Server 2012* ([1](https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/bcdedit--set)).

    - Отключает систему тиков TSC и использует вместо нее тик источника платформы (RTC).
    
        - Установка ``useplatformtick`` заставляет использовать RTC, который является устаревшей системой тикрейта. Поскольку она не является динамическим тиком и не имеет интеллектуальных оптимизаций, это может фактически снизить производительность вашей системы.

        - Принудительно устанавливает использование таймера на *0,5 мс* и *1,0 мс*.

- ``disabledynamictick`` - Microsoft: *Включает и выключает функцию динамического тика таймера* ([1](https://learn.microsoft.com/en-us/windows-hardware/drivers/devtest/bcdedit--set)).

    - Для получения дополнительной информации ознакомьтесь с [этим](https://en.wikipedia.org/wiki/Tickless_kernel#cite_note-ars-technica-win8-1) и [этим](https://arstechnica.com/information-technology/2012/10/better-on-the-inside-under-the-hood-of-windows-8/2/).

        - Когда динамический таймер включен: Функция объединяет тики таймера, когда система находится в режиме ожидания.

        - Отключение динамического таймера не даст значительных результатов, поскольку начиная с Windows 10 таймер почти не уходит в простой режим ([1](/docs/idle_by_timer_duration.png)).

        - В Windows 11, из-за того что приложения больше не зависят от одного таймера, отключение динамического таймера становится еще менее целесообразным.
     
## 38. Уборка и обслуживание

Регулярная проверка и обслуживание системы помогут поддерживать её в чистоте и порядке. Установите напоминание, чтобы не забывать об этом.

- Используйте инструменты, такие как [Bulk-Crap-Uninstaller](https://github.com/Klocman/Bulk-Crap-Uninstaller), для удаления программ. Обычная панель управления не всегда удаляет остаточные файлы.

- Применяйте [Autoruns](https://learn.microsoft.com/en-us/sysinternals/downloads/autoruns) для удаления нежелательных программ из автозагрузки и проверяйте его регулярно, особенно после установки новых приложений.

- Настройка очистки диска:

  - Откройте командную строку (``cmd``) и введите следующую команду, отметьте все пункты, кроме ``DirectX Shader Cache``, затем нажмите ``OK``:

      ```bat
      cleanmgr /sageset:0
      ```

  - Запустите очистку диска:

      ```bat
      cleanmgr /sagerun:0
      ```

- Проверьте следующие места на наличие остаточных файлов:

  - ``C:\`` - общий мусор
  - ``C:\ProgramData\Microsoft\Windows\Start Menu\Programs`` - ярлыки в меню "Пуск" (не удаляйте системные ярлыки)
  - ``C:\Windows\Prefetch`` - файлы предварительной выборки (папка не должна быть заполнена, если супервыборка отключена)
  - ``C:\Windows\SoftwareDistribution`` - кэш загрузки обновлений Windows
  - ``C:\Windows\Temp`` - временные файлы
  - ``%userprofile%`` - остаточный мусор
  - ``%userprofile%\AppData\Local\Temp`` - временные файлы
  - ``%userprofile%\AppData\Roaming\Microsoft\Windows\Start Menu\Programs`` - ярлыки в меню "Пуск" (не удаляйте системные ярлыки)
  - Пользовательские каталоги, такие как "Загрузки", "Документы", "Изображения", "Музыка", "Видео", "Рабочий стол".

- При желании очистите папку WinSxS, чтобы уменьшить её размер ([1](https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/clean-up-the-winsxs-folder?view=windows-11)) с помощью следующей команды в CMD. Учтите, что это может занять продолжительное время:

    ```bat
    DISM /Online /Cleanup-Image /StartComponentCleanup /ResetBase
    ```

- Удалите устаревшие точки восстановления системы на вкладке ``Защита системы``, введя ``sysdm.cpl`` в ``Win+R``. Если вы не используете точки восстановления, их можно полностью отключить.

## 39. Опционально: Отключение ненужных сервисов

Я не несу ответственности за возможные проблемы или BSOD. Идея заключается в том, чтобы отключить службы, когда вы используете приложение в реальном времени, и вернуть службы по умолчанию для всего остального.

> [!IMPORTANT]
> Начиная с версии 23h2 (май 2023 года) фоновые процессы ограничены в потреблении ресурсов ([1](https://blogs.windows.com/windowsdeveloper/2023/05/26/delivering-delightful-performance-for-more-than-one-billion-users-worldwide)). Влияние служб на производительность минимально. Я настоятельно рекомендую пропустить этот пункт или отключить только самые неиспользуемые службы вручную с помощью ServiWin, соблюдая зависимости.

- Вы можете настроить список, отредактировав файл ``C:\bin\minimal-services.ini`` в текстовом редакторе. В этом файле есть комментарии, которые помогут вам определить, нужны ли вам те или иные службы. Например, пользователю с Ethernet не нужны службы Wi-Fi. Если вы планируете редактировать ``minimal-services.ini``, ознакомьтесь с [синтаксисом файла конфигурации](https://github.com/valleyofdoom/service-list-builder).

- [Настройте статический IP-адрес](https://www.youtube.com/watch?t=36&v=5iRp1Nug0PU). Это необходимо, так как мы будем отключать службы, которые расходуют ресурсы, на которые полагается DHCP.

- Устройство ``Высокоточный таймер событий`` в диспетчере устройств использует IRQ 0 на большинстве систем AMD и может конфликтовать с устройством ``Системный таймер``, которое также использует IRQ 0. Единственный известный способ разрешить этот конфликт - отключить родительское устройство ````Системный таймер``, которое является ``Мостом ISA стандарта PCI``, отключив драйвер ``msisadrv`` (отредактируйте конфигурацию).

- Используйте следующую команду, чтобы предотвратить попытку службы защиты программного обеспечения зарегистрировать перезагрузку каждые 30 секунд, пока службы отключены ([1](/docs/software-protection-error.png)). Я не знаю точно, что это за проблемная служба, но источники в Интернете указывают на планировщик задач ([1](https://learn.microsoft.com/en-us/troubleshoot/windows-server/deployment/failed-schedule-software-protection), [2](https://superuser.com/questions/1501559/failed-to-schedule-software-protection-service-for-re-start-at-2119-10-19t1807)).

    ```bat
    reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SoftwareProtectionPlatform" /v "InactivityShutdownDelay" /t REG_DWORD /d "4294967295" /f
    ```

- Загрузите и распакуйте последнюю версию [service-list-builder](https://github.com/valleyofdoom/service-list-builder). Откройте командную строку (CMD) и перейдите в распакованную папку, где находится исполняемый файл.

- Используйте следующую команду для сборки скриптов в папке ``build``. Переместите папку сборки в безопасное место, например, ``C:\``, и не передавайте её другим людям, так как она специфична для вашей системы. Учтите, что для запуска пакетного скрипта требуется NSudo с опцией ``Enable All Privileges``.

    ```bat
    service-list-builder.exe --config C:\bin\minimal-services.ini
    ```

    - Если появляется предупреждение о службах, не относящихся к Windows, оцените службы в предупреждении, чтобы определить, хотите ли вы оставить их включенными, отредактировав конфигурационный файл, или отключить их с помощью аргумента ``-disable_service_warning``. Например, ``NVIDIA Display Container LS`` может появиться в предупреждении, поскольку это не служба Windows, но отключение её может быть целесообразным, если вам не нужен доступ к панели управления после запуска ``Services-Disable.bat``. В этом случае использование аргумента для игнорирования предупреждения будет уместным. Другой пример - ``vgc``, который необходим для античита Valorant, поэтому вы не захотите отключать его, и будет разумно добавить его в ``enabled_services`` в конфигурации, так как это служба пользовательского режима.

    - Если вы хотите перестроить скрипты, предварительно запустите сгенерированный скрипт ``Services-Enable.bat``, так как инструмент полагается на текущее состояние служб для построения будущих скриптов.

- При желании вы можете использовать [ServiWin](https://www.nirsoft.net/utils/serviwin.html) для проверки наличия остаточных драйверов после отключения служб и, возможно, создать проблему в репозитории, чтобы она была рассмотрена.

## 40. (В тестировании) Отключение MMCSS

- MMCSS (Служба планирования мультимедийных классов) является частью операционной системы Microsoft Windows и была разработана для улучшения обработки мультимедийных приложений, чувствительных к времени. Она обеспечивает этим процессам/потокам необходимое время работы на процессоре, позволяя при этом работать приложениям с более низким приоритетом. Разработчики могут регистрировать потоки своих приложений в MMCSS с настраиваемым набором групп мультимедийных задач, которые определяют, какой тип приоритета и ресурсов ЦП они должны получить ([1](https://github.com/djdallmann/GamingPCSetup/blob/master/CONTENT/RESEARCH/WINSERVICES/README.md#q-what-is-multimedia-class-scheduler-service-mmcss) [2](https://github.com/djdallmann/GamingPCSetup/blob/master/CONTENT/RESEARCH/WINSERVICES/README.md#q-what-is-multimedia-class-scheduler-service-mmcss)).

- Отключение MMCSS может привести к тому, что ``audiodg.exe`` перестанет получать буст приоритета, что может вызвать задержки звука на нестабильных системах.

- Отключение MMCSS может значительно снизить количество событий и ресурсов, используемых системой, что может быть полезно в определенных сценариях, особенно для игр или приложений, требующих высокой производительности. Однако это может также негативно сказаться на качестве звука и производительности мультимедийных приложений, поэтому перед отключением этой службы рекомендуется тщательно оценить влияние на вашу систему.

- Если вы решите отключить MMCSS, вы можете сделать это через редактор реестра. Откройте командную строку с правами администратора и введите следующую команду:

    ```bat
    sc config MMCSS start= disabled
    ```

- После отключения MMCSS рекомендуется протестировать производительность системы и качество звука в мультимедийных приложениях, чтобы убедиться, что отключение не привело к нежелательным последствиям.

- Если вы заметите ухудшение качества звука или другие проблемы, вы всегда можете вернуть службу в исходное состояние, выполнив следующую команду:

    ```bat
    sc config MMCSS start= auto
    ```

- После этого перезагрузите компьютер, чтобы изменения вступили в силу.

## Заключение

Регулярное обслуживание и оптимизация системы могут значительно улучшить её производительность и стабильность. Следуя приведённым рекомендациям, вы сможете поддерживать свою систему в чистоте и порядке, а также отключать ненужные службы для повышения общей эффективности. Однако всегда будьте осторожны при внесении изменений в системные настройки и службы, так как это может повлиять на работу приложений и общую стабильность системы. Рекомендуется делать резервные копии важных данных и создавать точки восстановления системы перед внесением значительных изменений.
